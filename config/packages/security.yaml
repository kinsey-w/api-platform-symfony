security:
    password_hashers:
        App\Entity\User:
            algorithm: auto

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: email

    firewalls:

        # --------------------
        # FRONTEND (session)
        # --------------------
        main:
            pattern: ^(?!/api)   # everything except /api
            lazy: true
            provider: app_user_provider
            entry_point: App\Security\LoginFormAuthenticator

            form_login:
                login_path: login
                check_path: login
                enable_csrf: true

            logout:
                path: logout
                target: login

            # important: frontend must NOT be stateless
            stateless: false


        # --------------------
        # API (JWT)
        # --------------------
        api:
            pattern: ^/api
            stateless: true
            provider: app_user_provider

            json_login:
                check_path: /api/auth
                username_path: email
                password_path: plainPassword
                success_handler: lexik_jwt_authentication.handler.authentication_success
                failure_handler: lexik_jwt_authentication.handler.authentication_failure

            jwt: ~

    access_control:
        # API Platform docs MUST remain public
        - { path: ^/api/docs, roles: PUBLIC_ACCESS }
        - { path: ^/api/contexts, roles: PUBLIC_ACCESS }
        - { path: ^/api$, roles: PUBLIC_ACCESS }

        # Allow GET on API resources (public browsing)
        - { path: ^/api, roles: PUBLIC_ACCESS, methods: [GET] }

        # Everything else in /api requires JWT
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY }
